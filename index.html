<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Gestión de Tickets - Acceso Seguro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --bg-sidebar: #1e293b;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f3f4f6; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 60; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
        
        .table-row-hover:hover { background-color: #f8fafc; }
        th { cursor: pointer; user-select: none; }
        th:hover { color: var(--primary); }

        /* Estilo para filas cobradas */
        .row-paid { background-color: #dcfce7 !important; color: #166534; }
        .row-paid td { border-color: #bbf7d0; }
        .row-paid:hover { background-color: #bbf7d0 !important; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        /* Estilos Login */
        .login-bg {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        /* Animación Chat */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .chat-anim { animation: fadeInScale 0.2s ease-out forwards; }
        
        /* Mensajes Chat */
        .msg-user { background-color: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-bot { background-color: #f1f5f9; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; line-height: 1.5; }
        .msg-system { background-color: #fee2e2; color: #991b1b; align-self: center; font-size: 0.75rem; width: 90%; text-align: center; border: 1px solid #fecaca; }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .toast { padding: 10px 20px; border-radius: 50px; color: white; font-size: 0.9rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: opacity 0.3s; opacity: 0; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container"></div>

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center login-bg transition-opacity duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Acceso Seguro</h2>
                <p class="text-sm text-gray-500 mt-2">Introduce tus credenciales para acceder al CRM</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <i class="fas fa-user"></i>
                        </div>
                        <input type="text" id="login-user" class="pl-10 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Usuario" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <i class="fas fa-lock"></i>
                        </div>
                        <input type="password" id="login-pass" class="pl-10 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="••••" required>
                    </div>
                </div>

                <div id="login-error" class="text-red-500 text-sm text-center hidden bg-red-50 p-2 rounded border border-red-100">
                    <i class="fas fa-exclamation-circle mr-1"></i> Credenciales incorrectas
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition transform hover:scale-[1.02] shadow-lg">
                    Entrar <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-gray-400">
                <p>Acceso restringido a usuarios autorizados</p>
            </div>
        </div>
    </div>

    <!-- MODAL COMPARADOR DE PRECIOS -->
    <div id="comparator-modal" class="fixed inset-0 z-[1100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeComparator()"></div>
        <div class="bg-white rounded-[40px] shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col relative overflow-hidden animate-slide-in">
            <!-- Header -->
            <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-blue-100">
                        <i class="fas fa-tags text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 tracking-tight">Comparador de Precios</h3>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Análisis de los últimos 30 días</p>
                    </div>
                </div>
                <button onclick="closeComparator()" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-white border border-slate-200 text-slate-400 hover:text-slate-600 transition">
                    <i class="fas fa-xmark text-lg"></i>
                </button>
            </div>
            
            <!-- Body -->
            <div class="p-8 flex-1 flex flex-col overflow-hidden space-y-8">
                <div class="relative">
                    <input type="text" id="comparator-search" placeholder="¿Qué producto quieres comparar? (Ej: Leche, Tomate...)" class="w-full pl-14 pr-6 py-5 bg-slate-100 border-none rounded-3xl text-lg font-medium focus:ring-4 focus:ring-blue-100 outline-none transition-all shadow-inner" onkeyup="handleComparatorSearch(event)">
                    <i class="fas fa-search absolute left-6 top-6 text-slate-400 text-xl"></i>
                </div>

                <div id="comparator-results" class="flex-1 flex flex-col lg:flex-row gap-8 overflow-hidden hidden">
                    <div class="flex-1 bg-white p-6 rounded-3xl border border-slate-100 shadow-sm relative h-full">
                        <canvas id="comparatorChart"></canvas>
                    </div>
                    <div class="w-full lg:w-96 overflow-y-auto custom-scroll pr-2 space-y-3" id="comparator-list">
                        <!-- Items comparativa -->
                    </div>
                </div>
                
                <div id="comparator-empty" class="flex-1 flex flex-col items-center justify-center text-center">
                    <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                        <i class="fas fa-basket-shopping text-4xl text-slate-200"></i>
                    </div>
                    <h4 class="text-xl font-black text-slate-400">Sin búsquedas activas</h4>
                    <p class="text-slate-300 text-sm mt-2 max-w-xs">Introduce el nombre de un producto para comparar precios entre supermercados</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENIDO DE LA APP -->
    <div id="app-content" class="hidden h-screen flex overflow-hidden relative opacity-0 transition-opacity duration-700">

        <div id="loader" class="loading-overlay">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
            <p class="text-gray-600 font-semibold" id="loader-text">Conectando con n8n...</p>
        </div>

        <!-- WIDGET CHATBOT -->
        <div id="chat-widget" class="fixed bottom-6 right-6 z-[80] flex flex-col items-end">
            
            <!-- Ventana de Chat (Oculta por defecto) -->
            <div id="chat-window" class="bg-white w-80 h-96 rounded-2xl shadow-2xl mb-4 border border-gray-200 hidden flex flex-col overflow-hidden chat-anim">
                <!-- Header Chat -->
                <div class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-2">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-sm">Asistente Virtual</h4>
                            <div class="flex items-center text-xs text-blue-200">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span> Online
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleChat()" class="text-blue-200 hover:text-white transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Area Mensajes -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-3 custom-scroll flex flex-col">
                    <div class="msg-bot p-3 rounded-2xl rounded-tl-none text-sm max-w-[85%] shadow-sm">
                        ¡Hola! Soy tu asistente financiero. ¿En qué puedo ayudarte hoy con tus gastos?
                    </div>
                </div>

                <!-- Input Chat -->
                <div class="p-3 border-t border-gray-100 bg-white flex items-center gap-2">
                    <input type="text" id="chat-input" placeholder="Escribe un mensaje..." 
                           class="flex-1 bg-gray-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                           onkeypress="handleChatEnter(event)">
                    <button onclick="sendChatMessage()" class="w-9 h-9 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed" id="chat-send-btn">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Botón Flotante -->
            <button onclick="toggleChat()" id="chat-fab" class="w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition transform hover:scale-110 flex items-center justify-center">
                <i class="fas fa-comment-dots fa-lg"></i>
            </button>
        </div>

        <div id="mobile-menu-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300 opacity-0 md:hidden"></div>
        <div id="details-overlay" onclick="closeSidebar()" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden transition-opacity duration-300 opacity-0"></div>
        
        <div id="details-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center shadow-md shrink-0">
                <div>
                    <h3 class="font-bold text-lg" id="sidebar-title">Detalles</h3>
                    <p class="text-xs text-blue-200" id="sidebar-subtitle">Últimos 30 días</p>
                </div>
                <button onclick="closeSidebar()" class="hover:bg-blue-700 p-2 rounded-full transition-colors w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-3 bg-blue-50 border-b border-blue-100 shrink-0 flex justify-between items-center">
                <span class="text-xs font-semibold text-blue-800 uppercase tracking-wide">Tickets Recientes</span>
                <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full" id="sidebar-count">0 tickets</span>
            </div>
            <div class="flex-1 overflow-y-auto p-4 custom-scroll space-y-3" id="sidebar-content"></div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 shrink-0 text-center">
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Total Grupo</span>
                    <span class="text-xl font-black text-blue-600" id="sidebar-total-sum">0.00 €</span>
                </div>
            </div>
        </div>

        <aside id="main-sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 text-white flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:relative md:z-0 shadow-xl md:shadow-none">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-blue-400"><i class="fas fa-receipt mr-2"></i>TicketCRM</h1>
                    <p class="text-xs text-slate-400 mt-1">Gestión de Gastos</p>
                </div>
                <button onclick="toggleMobileMenu()" class="md:hidden text-slate-400 hover:text-white p-2">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="#" class="flex items-center p-3 bg-blue-600 rounded-lg text-white shadow-lg" onclick="toggleMobileMenu()">
                    <i class="fas fa-chart-line w-6 text-center"></i> <span class="ml-2">Dashboard</span>
                </a>
                
                <a href="#" onclick="openComparator(); toggleMobileMenu()" class="flex items-center p-3 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <i class="fas fa-tags w-6 text-center"></i> <span class="ml-2">Comparador</span>
                </a>

                <div class="mt-8">
                    <p class="text-xs uppercase text-slate-500 font-bold mb-3 px-3">Filtros Rápidos</p>
                    <div class="px-3 space-y-3">
                        <div>
                            <label class="text-xs text-slate-400">Supermercado</label>
                            <select id="filter-supermarket" class="w-full bg-slate-700 text-sm rounded p-2 mt-1 border border-slate-600 focus:border-blue-500 outline-none" onchange="applyFilters(); toggleMobileMenu()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Categoría</label>
                            <select id="filter-category" class="w-full bg-slate-700 text-sm rounded p-2 mt-1 border border-slate-600 focus:border-blue-500 outline-none" onchange="applyFilters(); toggleMobileMenu()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Usuario</label>
                            <select id="filter-user" class="w-full bg-slate-700 text-sm rounded p-2 mt-1 border border-slate-600 focus:border-blue-500 outline-none" onchange="applyFilters(); toggleMobileMenu()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="pt-2 border-t border-slate-700 mt-2">
                            <label class="text-xs text-slate-400 block mb-1">Rango de Fechas</label>
                            <div class="space-y-2">
                                <div>
                                    <label class="text-[10px] text-slate-500 uppercase">Desde</label>
                                    <input type="date" id="filter-date-start" class="w-full bg-slate-700 text-sm rounded p-2 border border-slate-600 focus:border-blue-500 outline-none text-slate-200" onchange="applyFilters()">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 uppercase">Hasta</label>
                                    <input type="date" id="filter-date-end" class="w-full bg-slate-700 text-sm rounded p-2 border border-slate-600 focus:border-blue-500 outline-none text-slate-200" onchange="applyFilters()">
                                </div>
                            </div>
                        </div>
                        <button onclick="resetFilters(); toggleMobileMenu()" class="w-full py-2 text-xs border border-slate-600 rounded hover:bg-slate-700 mt-2 transition-colors">
                            Limpiar Filtros
                        </button>
                    </div>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-700 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-sm font-bold text-white mr-2">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white" id="current-user-display">Usuario</p>
                        <p class="text-[10px] text-green-400">Conectado</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-slate-400 hover:text-red-400" title="Cerrar Sesión">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden w-full">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 shrink-0">
                <div class="flex items-center text-gray-800">
                    <button onclick="toggleMobileMenu()" class="md:hidden mr-4 text-gray-600 hover:text-blue-600 focus:outline-none cursor-pointer p-2 rounded-md hover:bg-gray-100 transition-colors">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h2 class="text-xl font-semibold truncate">Resumen General</h2>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <div id="connection-status" class="hidden md:flex text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-700 items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div> Online
                    </div>
                    <div class="md:hidden w-3 h-3 bg-green-500 rounded-full animate-pulse" title="Online"></div>
                    <button onclick="fetchData()" class="text-gray-500 hover:text-blue-600 p-2" title="Recargar datos">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
                    <!-- Card 1: Ingreso Mes Anterior -->
                    <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden hover:shadow-md transition">
                        <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-emerald-600"><i class="fas fa-arrow-trend-up fa-2x md:fa-3x"></i></div>
                        <p class="text-gray-500 text-xs md:text-sm font-medium">Ingreso Mes Anterior</p>
                        <h3 class="text-lg md:text-2xl font-bold text-emerald-600 mt-1 truncate" id="kpi-income-prev">0.00 €</h3>
                    </div>
                    <!-- Card 2: Gasto Mes Anterior -->
                    <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden hover:shadow-md transition">
                        <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-red-600"><i class="fas fa-arrow-trend-down fa-2x md:fa-3x"></i></div>
                        <p class="text-gray-500 text-xs md:text-sm font-medium">Gasto Mes Anterior</p>
                        <h3 class="text-lg md:text-2xl font-bold text-red-600 mt-1 truncate" id="kpi-expense-prev">0.00 €</h3>
                    </div>
                    <!-- Card 3: Ingreso Mes Actual -->
                    <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden hover:shadow-md transition">
                        <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-emerald-600"><i class="fas fa-hand-holding-dollar fa-2x md:fa-3x"></i></div>
                        <p class="text-gray-500 text-xs md:text-sm font-medium">Ingreso Mes Actual</p>
                        <h3 class="text-lg md:text-2xl font-bold text-emerald-600 mt-1" id="kpi-income-current">0.00 €</h3>
                    </div>
                    <!-- Card 4: Gasto Mes Actual -->
                    <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden hover:shadow-md transition">
                        <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-red-600"><i class="fas fa-money-bill-wave fa-2x md:fa-3x"></i></div>
                        <p class="text-gray-500 text-xs md:text-sm font-medium">Gasto Mes Actual</p>
                        <h3 class="text-lg md:text-2xl font-bold text-red-600 mt-1" id="kpi-expense-current">0.00 €</h3>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-gray-700 font-bold text-sm md:text-base uppercase">SUPERMERCADO</h3>
                            <span class="text-[10px] md:text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded-full cursor-help flex items-center"><i class="fas fa-mouse-pointer mr-1"></i> <span class="hidden md:inline">Interactivo</span></span>
                        </div>
                        <div class="h-56 md:h-64">
                            <canvas id="vendorChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-gray-700 font-bold text-sm md:text-base uppercase">CATEGORIAS</h3>
                            <span class="text-[10px] md:text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded-full cursor-help flex items-center"><i class="fas fa-mouse-pointer mr-1"></i> <span class="hidden md:inline">Interactivo</span></span>
                        </div>
                        <div class="h-56 md:h-64 flex justify-center">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                 <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
                    <h3 class="text-gray-700 font-bold mb-4 text-sm md:text-base">Evolución de Gasto Diario</h3>
                    <div class="h-56 md:h-64 w-full">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 md:p-5 border-b border-gray-100 flex flex-col md:flex-row justify-between md:items-center gap-4">
                        <h3 class="text-lg font-bold text-gray-800">Detalle de Tickets</h3>
                        <div class="flex gap-2 w-full md:w-auto">
                            <!-- BOTÓN EXPORTAR CSV -->
                            <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition flex items-center gap-2 shadow-sm">
                                <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Descargar Excel</span>
                            </button>
                            <div class="relative w-full md:w-64">
                                <input type="text" id="search-input" placeholder="Buscar..." 
                                       class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 w-full"
                                       onkeyup="handleSearch()">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3" onclick="sortTable('Fecha')">Fecha <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                    <th class="px-6 py-3" onclick="sortTable('Supermercado')">Super <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                    <th class="px-6 py-3 hidden sm:table-cell" onclick="sortTable('Categoria')">Cat. <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                    <th class="px-6 py-3 text-right" onclick="sortTable('Total')">Total <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                    <th class="px-6 py-3 text-center">Cobrado</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-100 flex justify-between items-center flex-wrap gap-2">
                        <span class="text-xs text-gray-500" id="pagination-info">Mostrando 0-0</span>
                        <div class="flex gap-2">
                            <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded text-gray-600 hover:bg-gray-200 text-xs disabled:opacity-50" id="btn-prev">Anterior</button>
                            <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded text-gray-600 hover:bg-gray-200 text-xs disabled:opacity-50" id="btn-next">Siguiente</button>
                        </div>
                    </div>
                </div>

                <footer class="mt-8 text-center text-xs text-gray-400 pb-4">
                    CRM Generado para Gestión de ODS &copy; 2025
                </footer>
            </div>
        </main>
    </div>

    <script>
        // CONFIGURACIÓN DE URLS - AQUÍ DEBES PONER TUS URLS REALES
        const WEBHOOK_URL = 'https://automatizaciones-n8n.ztzbzz.easypanel.host/webhook/64dbf343-08e3-4a0b-8c8f-cd87c1554115';
        const CHAT_WEBHOOK = 'https://automatizaciones-n8n.ztzbzz.easypanel.host/webhook/849d797e-7a0a-41df-9751-14166ad02a75';
        const UPDATE_WEBHOOK_URL = 'https://automatizaciones-n8n.ztzbzz.easypanel.host/webhook/UPDATE_TICKET_STATUS'; 
        
        // --- NUEVA URL PARA TABLA ---
        const TABLE_WEBHOOK_URL = 'https://automatizaciones-n8n.ztzbzz.easypanel.host/webhook/653d11e8-ccde-43e6-a286-874b505f0391';

        // --- LOGICA DE PROXIES PARA CHAT ---
        const PROXIES = [
            "", // Intento directo
            "https://corsproxy.io/?",
            "https://api.allorigins.win/raw?url="
        ];

        const VALID_USERS = {
            'francis': 'Galvan@7678',
            'sonia': 'Minie@7678'
        };

        // --- FUNCIONES TOAST ---
        function showToast(message, color = "blue") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgClass = "bg-blue-600";
            if (color === "green") bgClass = "bg-green-600";
            if (color === "red") bgClass = "bg-red-600";
            if (color === "orange") bgClass = "bg-orange-500";

            toast.className = `toast ${bgClass}`;
            toast.innerHTML = message;
            
            container.appendChild(toast);
            
            // Animación Entrada
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Animación Salida
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- LOGIN ---
        function checkSession() {
            const session = localStorage.getItem('crm_session_user');
            if (session) {
                showApp(session);
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('login-user').value.toLowerCase().trim();
            const pass = document.getElementById('login-pass').value.trim();
            const errorDiv = document.getElementById('login-error');

            if (VALID_USERS[user] && VALID_USERS[user] === pass) {
                localStorage.setItem('crm_session_user', user);
                errorDiv.classList.add('hidden');
                showApp(user);
            } else {
                errorDiv.classList.remove('hidden');
                document.getElementById('login-pass').value = '';
            }
        }

        function logout() {
            localStorage.removeItem('crm_session_user');
            location.reload();
        }

        function showApp(username) {
            document.getElementById('login-screen').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('login-screen').classList.add('hidden');
            }, 500);

            const appContent = document.getElementById('app-content');
            appContent.classList.remove('hidden');
            setTimeout(() => appContent.classList.remove('opacity-0'), 50);
            
            document.getElementById('current-user-display').innerText = username.charAt(0).toUpperCase() + username.slice(1);
            fetchData();
        }

        checkSession();

        // --- LOGICA DEL CRM ---
        let allData = []; // Datos para gráficos (Webhook original)
        let filteredData = []; // Datos filtrados para gráficos
        
        let tableRawData = []; // NUEVO: Datos para la tabla (Nuevo Webhook)
        let filteredTableData = []; // NUEVO: Datos filtrados para la tabla

        let currentPage = 1;
        const rowsPerPage = 10;
        let sortCol = 'Fecha';
        let sortAsc = false;
        let charts = { vendor: null, category: null, timeline: null, comparator: null };
        // Persistencia de Tickets Cobrados
        let paidTickets = new Set(JSON.parse(localStorage.getItem('paid_tickets') || '[]'));

        function toggleMobileMenu() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('mobile-menu-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // --- FETCH DATOS ---
        async function fetchData() {
            const loader = document.getElementById('loader');
            if (loader) loader.style.display = 'flex';

            // 1. CARGAR DATOS GENERALES (Gráficos)
            let success = false;
            for (const proxy of PROXIES) {
                try {
                    const target = proxy + encodeURIComponent(WEBHOOK_URL);
                    const url = proxy === "" ? WEBHOOK_URL : target;
                    const response = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
                    if (response.ok) {
                        const json = await response.json();
                        const data = (json.contents && proxy.includes('allorigins')) ? JSON.parse(json.contents) : json;
                        if (Array.isArray(data) && data.length > 0) {
                            allData = processData(data);
                            success = true;
                            break;
                        }
                    }
                } catch (e) { console.log("Chart fetch error", e); }
            }

            if (!success) {
                console.warn("Fallo conexión gráficos:", "Usando Demo");
                allData = generateDemoData();
            }

            // 2. CARGAR DATOS TABLA (Nuevo Webhook)
            let tableSuccess = false;
            for (const proxy of PROXIES) {
                try {
                    const target = proxy + encodeURIComponent(TABLE_WEBHOOK_URL);
                    const url = proxy === "" ? TABLE_WEBHOOK_URL : target;
                    const response = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
                    if (response.ok) {
                        const json = await response.json();
                        const data = (json.contents && proxy.includes('allorigins')) ? JSON.parse(json.contents) : json;
                        if (Array.isArray(data) && data.length > 0) {
                            tableRawData = processData(data);
                            
                            // --- SINCRONIZACIÓN DE ESTADO DE COBRO (NUEVO) ---
                            // Actualizamos el Set local 'paidTickets' basándonos en los datos del servidor
                            tableRawData.forEach(item => {
                                const key = `${item.Fecha}_${item.Hora}_${item.Supermercado}_${item.Usuario}`;
                                const estado = String(item.Cobrado || "").toUpperCase().trim();
                                
                                if (estado === 'COBRADO') {
                                    paidTickets.add(key);
                                } else {
                                    // Si es PENDIENTE o vacío, aseguramos que NO esté marcado
                                    paidTickets.delete(key);
                                }
                            });
                            // Persistimos el estado sincronizado
                            localStorage.setItem('paid_tickets', JSON.stringify([...paidTickets]));
                            // -------------------------------------------------

                            tableSuccess = true;
                            break;
                        }
                    }
                } catch (e) { console.log("Table fetch error", e); }
            }

            if (!tableSuccess) {
                console.warn("Fallo conexión tabla");
                tableRawData = []; // O fallback a demo si se prefiere
            }

            populateFilters();
            applyFilters();
            if (loader) loader.style.display = 'none';
        }

        // --- PROCESAMIENTO DE DATOS CON HORA ---
        function processData(data) {
            return data.map(item => {
                const rawPrecio = parseFloat(item["Precio Unitario"]) || 0;
                const rawTotal = parseFloat(item.Total) || 0;
                const qty = parseFloat(item.CantidadPeso) || 1;
                const precioUnitario = rawPrecio > 0 ? rawPrecio : (qty > 0 ? rawTotal / qty : 0);
                
                const rawArticulo = String(item.Articulo || "Producto Vario");
                
                // NUEVA LÓGICA: Artículo Normalizado (MÁS ROBUSTA)
                // Busca el campo con variantes comunes para evitar fallos si el nombre cambia ligeramente
                const normRaw = item['Articulo-Normalizado'] || item['articulo-normalizado'] || item['Articulo_Normalizado'];
                
                const articuloNormalizado = normRaw ? String(normRaw) : rawArticulo.toUpperCase();

                return {
                    Supermercado: String(item.Supermercado || "Desconocido"),
                    Direccion: item.Direccion || "",
                    Poblacion: item.Poblacion || "General",
                    Fecha: item.Fecha || new Date().toISOString().split('T')[0],
                    // AÑADIDO: Campo Hora
                    Hora: item.Hora || "00:00:00",
                    Articulo: rawArticulo,
                    ArticuloNormalizado: articuloNormalizado, // CAMPO SEGURO
                    CantidadPeso: qty,
                    Total: rawTotal,
                    Categoria: String(item.Categoria || "Otros"),
                    Usuario: item.Usuario || "Desconocido",
                    PrecioUnitario: precioUnitario,
                    Descuento: parseFloat(item.Descuento) || 0,
                    Cobrado: item.Cobrado // Guardamos el campo original para referencia si hiciera falta
                };
            });
        }

        function generateDemoData() {
            const vendors = ['LIDL', 'Mercadona', 'Carrefour', 'Dia', 'Repsol'];
            const cats = ['Alimentación', 'Higiene', 'Limpieza', 'Gasolina', 'Bazar'];
            const products = ['Leche', 'Pan', 'Detergente', 'Gasolina 95', 'Galletas', 'Tomate', 'Verdura', 'Champú'];
            const users = ['Juan', 'Maria', 'Carlos'];
            let data = [];
            for(let i=0; i<50; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30)); // 30 días para asegurar visibilidad en comparador
                const total = parseFloat((Math.random() * 20 + 1).toFixed(2));
                const qty = Math.floor(Math.random() * 3) + 1;
                
                // AÑADIDO: Generar hora aleatoria para demos
                const hour = String(Math.floor(Math.random() * 24)).padStart(2, '0') + ":" + String(Math.floor(Math.random() * 60)).padStart(2, '0');
                
                const art = products[Math.floor(Math.random()*products.length)];

                data.push({
                    Supermercado: vendors[Math.floor(Math.random()*vendors.length)],
                    Direccion: 'Calle Demo ' + i,
                    Poblacion: i % 2 === 0 ? 'Sevilla' : 'Dos Hermanas',
                    Fecha: date.toISOString().split('T')[0],
                    Hora: hour,
                    Articulo: art,
                    ArticuloNormalizado: art.toUpperCase(), // AÑADIDO MANUALMENTE PARA DEMO
                    CantidadPeso: qty,
                    Total: total,
                    PrecioUnitario: total/qty,
                    Categoria: cats[Math.floor(Math.random()*cats.length)],
                    Usuario: users[Math.floor(Math.random()*users.length)]
                });
            }
            return data;
        }

        function populateFilters() {
            // Combinar datos para que los filtros funcionen en ambas fuentes
            const combinedData = [...allData, ...tableRawData];
            
            const vendors = [...new Set(combinedData.map(d => d.Supermercado))].sort();
            const cats = [...new Set(combinedData.map(d => d.Categoria))].sort();
            const users = [...new Set(combinedData.map(d => d.Usuario))].sort();

            const updateSel = (id, arr) => {
                const el = document.getElementById(id);
                const current = el.value;
                el.innerHTML = '<option value="">Todos</option>';
                arr.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v; opt.innerText = v;
                    el.appendChild(opt);
                });
                if (arr.includes(current)) el.value = current;
            };

            updateSel('filter-supermarket', vendors);
            updateSel('filter-category', cats);
            updateSel('filter-user', users);
        }

        function applyFilters() {
            const vendorFilter = document.getElementById('filter-supermarket').value;
            const catFilter = document.getElementById('filter-category').value;
            const userFilter = document.getElementById('filter-user').value;
            const dateStart = document.getElementById('filter-date-start').value;
            const dateEnd = document.getElementById('filter-date-end').value;
            const search = document.getElementById('search-input').value.toLowerCase();

            // Función de filtrado genérica
            const filterFn = (item) => {
                const matchVendor = !vendorFilter || item.Supermercado === vendorFilter;
                const matchCat = !catFilter || item.Categoria === catFilter;
                const matchUser = !userFilter || item.Usuario === userFilter;
                const matchDateStart = !dateStart || item.Fecha >= dateStart;
                const matchDateEnd = !dateEnd || item.Fecha <= dateEnd;
                const art = String(item.Articulo).toLowerCase();
                const sup = String(item.Supermercado).toLowerCase();
                // NUEVA LÓGICA: Búsqueda en ArticuloNormalizado
                const normArt = String(item.ArticuloNormalizado || "").toLowerCase();
                const matchSearch = !search || art.includes(search) || sup.includes(search) || normArt.includes(search);
                return matchVendor && matchCat && matchUser && matchDateStart && matchDateEnd && matchSearch;
            };

            // Filtrar GRÁFICOS (Fuente original)
            filteredData = allData.filter(filterFn);

            // Filtrar TABLA (Fuente nueva)
            filteredTableData = tableRawData.filter(filterFn);

            // Ordenar Tabla
            filteredTableData.sort((a, b) => {
                let valA = a[sortCol];
                let valB = b[sortCol];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return sortAsc ? -1 : 1;
                if (valA > valB) return sortAsc ? 1 : -1;
                return 0;
            });

            currentPage = 1;
            updateDashboard(); // Usa filteredData (Charts)
            renderTable();     // Usa filteredTableData (Tabla)
            renderCharts();    // Usa filteredData (Charts)
        }

        function resetFilters() {
            ['filter-supermarket', 'filter-category', 'filter-user', 'filter-date-start', 'filter-date-end', 'search-input'].forEach(id => document.getElementById(id).value = "");
            applyFilters();
        }

        function handleSearch() { applyFilters(); }
        function sortTable(col) {
            if (sortCol === col) sortAsc = !sortAsc;
            else { sortCol = col; sortAsc = true; }
            applyFilters();
        }
        function prevPage() { if(currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { if((currentPage * rowsPerPage) < filteredTableData.length) { currentPage++; renderTable(); } }

        function updateDashboard() {
            // KPIs usan datos de GRÁFICOS (filteredData)
            // Lógica para separar Ingresos (negativos) y Gastos (positivos)
            
            const vendorFilter = document.getElementById('filter-supermarket').value;
            const catFilter = document.getElementById('filter-category').value;
            const userFilter = document.getElementById('filter-user').value;

            const contextualData = allData.filter(item => {
                return (!vendorFilter || item.Supermercado === vendorFilter) &&
                       (!catFilter || item.Categoria === catFilter) &&
                       (!userFilter || item.Usuario === userFilter);
            });

            const now = new Date();
            const currMonth = now.getMonth(), currYear = now.getFullYear();
            const prevDate = new Date(); prevDate.setMonth(prevDate.getMonth() - 1);
            const prevMonth = prevDate.getMonth(), prevYear = prevDate.getFullYear();

            // Función auxiliar para sumar ingresos y gastos
            const calculateSums = (data) => {
                return data.reduce((acc, curr) => {
                    if (curr.Total < 0) {
                        acc.income += Math.abs(curr.Total); // Sumar como positivo
                    } else {
                        acc.expense += curr.Total;
                    }
                    return acc;
                }, { income: 0, expense: 0 });
            };

            // Filtrar datos por mes
            const currentMonthData = contextualData.filter(item => {
                const d = new Date(item.Fecha);
                return d.getMonth() === currMonth && d.getFullYear() === currYear;
            });

            const prevMonthData = contextualData.filter(item => {
                const d = new Date(item.Fecha);
                return d.getMonth() === prevMonth && d.getFullYear() === prevYear;
            });

            const currSums = calculateSums(currentMonthData);
            const prevSums = calculateSums(prevMonthData);

            // Actualizar DOM (CON COLORES SEMÁNTICOS)
            document.getElementById('kpi-income-prev').innerText = prevSums.income.toLocaleString('es-ES', {style: 'currency', currency: 'EUR'});
            document.getElementById('kpi-expense-prev').innerText = prevSums.expense.toLocaleString('es-ES', {style: 'currency', currency: 'EUR'});
            
            document.getElementById('kpi-income-current').innerText = currSums.income.toLocaleString('es-ES', {style: 'currency', currency: 'EUR'});
            document.getElementById('kpi-expense-current').innerText = currSums.expense.toLocaleString('es-ES', {style: 'currency', currency: 'EUR'});
        }

        // --- FUNCIÓN DE AGRUPACIÓN ACTUALIZADA CON HORA ---
        function groupTickets(data) {
            const grouped = {};
            data.forEach(item => {
                // CLAVE ÚNICA AHORA INCLUYE LA HORA
                const key = `${item.Fecha}_${item.Hora}_${item.Supermercado}_${item.Usuario}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        id: key, 
                        Fecha: item.Fecha,
                        Hora: item.Hora, // Guardamos la hora para visualizar
                        Supermercado: item.Supermercado,
                        Poblacion: item.Poblacion,
                        Usuario: item.Usuario,
                        Total: 0,
                        Items: [],
                        Categorias: new Set()
                    };
                }
                grouped[key].Total += item.Total;
                grouped[key].Items.push(item.Articulo);
                grouped[key].Categorias.add(item.Categoria);
            });

            return Object.values(grouped).map(g => {
                let catText = "Varios";
                if(g.Categorias.size === 1) catText = Array.from(g.Categorias)[0];
                else if(g.Categorias.size > 1) catText = "Compra Mixta";

                let artText = g.Items[0];
                if (g.Items.length > 1) artText += `, ${g.Items[1]}`;
                if (g.Items.length > 2) artText += ` y ${g.Items.length - 2} más...`;

                return {
                    id: g.id,
                    Fecha: g.Fecha,
                    Supermercado: g.Supermercado,
                    Articulo: artText, 
                    Categoria: catText,
                    Poblacion: g.Poblacion,
                    Usuario: g.Usuario,
                    Total: g.Total
                };
            });
        }

        // --- SIDEBAR DETALLES ---
        function openSidebar(title, filterKey, filterValue) {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            const content = document.getElementById('sidebar-content');
            
            document.getElementById('sidebar-title').innerText = filterValue;
            
            const dates = allData.map(d => new Date(d.Fecha));
            const maxDate = new Date(Math.max.apply(null, dates));
            const minDate = new Date(maxDate);
            minDate.setDate(minDate.getDate() - 30); 

            const detailsData = allData.filter(d => {
                const dDate = new Date(d.Fecha);
                return d[filterKey] === filterValue && dDate >= minDate;
            });
            
            detailsData.sort((a,b) => new Date(b.Fecha) - new Date(a.Fecha));

            document.getElementById('sidebar-subtitle').innerText = `Del ${minDate.toLocaleDateString()} al ${maxDate.toLocaleDateString()}`;
            document.getElementById('sidebar-count').innerText = `${detailsData.length} tickets`;

            content.innerHTML = '';
            if(detailsData.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-inbox fa-2x mb-2"></i><br>Sin movimientos recientes</div>';
            } else {
                detailsData.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-shadow";
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-gray-800 text-sm truncate w-3/4">${item.Articulo}</span>
                            <span class="font-bold text-blue-600 text-sm">${item.Total.toFixed(2)}€</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span><i class="far fa-calendar mr-1"></i>${item.Fecha}</span>
                            <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[100px]">${item.Supermercado}</span>
                        </div>
                    `;
                    content.appendChild(el);
                });
            }

            // CALCULAR TOTAL DEL SIDEBAR CON COLOR SEMÁNTICO
            const totalSum = detailsData.reduce((a,b) => a+b.Total, 0);
            const sumColor = totalSum < 0 ? 'text-emerald-600' : 'text-red-600';
            const sumEl = document.getElementById('sidebar-total-sum');
            sumEl.innerText = totalSum.toFixed(2) + " €";
            // Reset y aplicar color
            sumEl.className = `text-xl font-black ${sumColor}`;

            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            sidebar.classList.remove('translate-x-full');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            sidebar.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        // --- ACTUALIZACIÓN DE ESTADO CON NUEVA ESTRUCTURA ---
        async function togglePaid(ticketId) {
            const isPaid = !paidTickets.has(ticketId); 
            
            if (isPaid) {
                paidTickets.add(ticketId);
            } else {
                paidTickets.delete(ticketId);
            }
            localStorage.setItem('paid_tickets', JSON.stringify([...paidTickets]));
            renderTable();

            showToast("Sincronizando...", "blue");
            
            try {
                // AHORA TENEMOS 4 CAMPOS EN EL ID
                const [fecha, hora, superm, user] = ticketId.split('_');

                const response = await fetch(UPDATE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_status',
                        ticket_id: ticketId,
                        date: fecha,
                        time: hora, // Enviamos también la hora
                        supermarket: superm,
                        user: user,
                        status: isPaid ? 'COBRADO' : 'PENDIENTE'
                    })
                });

                if (response.ok) {
                    showToast("Guardado en servidor", "green");
                } else {
                    console.warn("El servidor no respondió OK, pero el cambio local persiste.");
                    showToast("Guardado localmente", "orange");
                }
            } catch (error) {
                console.warn("No se pudo conectar al webhook de actualización", error);
                showToast("Error de conexión (Guardado solo local)", "orange");
            }
        }

        function exportToCSV() {
            // USAR filteredTableData para exportar lo que se ve en tabla
            if (!filteredTableData.length) return alert("No hay datos para exportar");

            // Preparar datos con la marca de cobrado usando el nuevo formato de clave
            const exportData = filteredTableData.map(item => {
                const key = `${item.Fecha}_${item.Hora}_${item.Supermercado}_${item.Usuario}`;
                const isPaid = paidTickets.has(key) ? "COBRADO" : "PENDIENTE";
                return {
                    ...item,
                    Estado_Cobro: isPaid
                };
            });

            // Convertir a CSV
            const headers = Object.keys(exportData[0]);
            const csvRows = [
                headers.join(','), // Cabecera
                ...exportData.map(row => headers.map(fieldName => {
                    let val = row[fieldName];
                    // Escapar comillas y convertir a string
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(','))
            ];

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `tickets_export_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            // Usamos filteredTableData (Datos del Nuevo Webhook)
            const groupedData = groupTickets(filteredTableData);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = groupedData.slice(start, end);

            // Función para generar color consistente basado en texto
            const getCategoryStyle = (category) => {
                const normalizedCat = String(category).toUpperCase().trim();
                
                // Mapeo específico solicitado y comunes
                const specificMap = {
                    'ROPA Y COMPLEMENTOS': 'bg-green-100 text-green-800 border-green-200', // Solicitado: Verde
                    'CAFETERÍAS Y RESTAURANTES': 'bg-blue-100 text-blue-800 border-blue-200', // Solicitado: Azul
                    'ALIMENTACIÓN': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                    'SUPERMERCADO': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                    'GASOLINA': 'bg-red-100 text-red-800 border-red-200',
                    'COMBUSTIBLE': 'bg-red-100 text-red-800 border-red-200',
                    'FARMACIA': 'bg-teal-100 text-teal-800 border-teal-200',
                    'SALUD': 'bg-teal-100 text-teal-800 border-teal-200',
                    'HOGAR': 'bg-orange-100 text-orange-800 border-orange-200',
                    'MANTENIMIENTO': 'bg-gray-100 text-gray-800 border-gray-200',
                    'OCIO': 'bg-purple-100 text-purple-800 border-purple-200',
                    'VIAJES': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                    'EDUCACIÓN': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                    'REGALOS': 'bg-pink-100 text-pink-800 border-pink-200',
                    'BAZAR': 'bg-amber-100 text-amber-800 border-amber-200'
                };

                // Búsqueda exacta
                if (specificMap[normalizedCat]) return specificMap[normalizedCat];

                // Búsqueda parcial si no hay exacta
                for (const key in specificMap) {
                    if (normalizedCat.includes(key)) return specificMap[key];
                }

                // Si no está en la lista, generamos uno basado en el hash del string
                const colors = [
                    'bg-slate-100 text-slate-800 border-slate-200',
                    'bg-zinc-100 text-zinc-800 border-zinc-200',
                    'bg-stone-100 text-stone-800 border-stone-200',
                    'bg-red-100 text-red-800 border-red-200',
                    'bg-orange-100 text-orange-800 border-orange-200',
                    'bg-amber-100 text-amber-800 border-amber-200',
                    'bg-yellow-100 text-yellow-800 border-yellow-200',
                    'bg-lime-100 text-lime-800 border-lime-200',
                    'bg-green-100 text-green-800 border-green-200',
                    'bg-emerald-100 text-emerald-800 border-emerald-200',
                    'bg-teal-100 text-teal-800 border-teal-200',
                    'bg-cyan-100 text-cyan-800 border-cyan-200',
                    'bg-sky-100 text-sky-800 border-sky-200',
                    'bg-blue-100 text-blue-800 border-blue-200',
                    'bg-indigo-100 text-indigo-800 border-indigo-200',
                    'bg-violet-100 text-violet-800 border-violet-200',
                    'bg-purple-100 text-purple-800 border-purple-200',
                    'bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200',
                    'bg-pink-100 text-pink-800 border-pink-200',
                    'bg-rose-100 text-rose-800 border-rose-200'
                ];
                
                let hash = 0;
                for (let i = 0; i < normalizedCat.length; i++) {
                    hash = normalizedCat.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash) % colors.length;
                return colors[index];
            };

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No se encontraron datos</td></tr>';
                document.getElementById('pagination-info').innerText = '0 de 0';
                return;
            }

            pageData.forEach(row => {
                const isPaid = paidTickets.has(row.id);
                const tr = document.createElement('tr');
                tr.className = `bg-white border-b hover:bg-gray-50 transition table-row-hover ${isPaid ? 'row-paid opacity-75' : ''}`;
                
                // Determinar el estilo de la categoría dinámicamente
                let catClass = getCategoryStyle(row.Categoria);

                // Determinar color del TOTAL (Ingreso vs Gasto)
                const totalVal = parseFloat(row.Total);
                const moneyColor = totalVal < 0 ? 'text-emerald-600' : 'text-red-600';

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${row.Fecha}</td>
                    <td class="px-6 py-4">${row.Supermercado}</td>
                    <td class="px-6 py-4 hidden sm:table-cell">
                        <span class="${catClass} border text-[10px] font-bold mr-2 px-2.5 py-1 rounded-full uppercase tracking-wide shadow-sm whitespace-nowrap">
                            ${row.Categoria}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right font-bold ${moneyColor}">${totalVal.toFixed(2)} €</td>
                    <td class="px-6 py-4 text-center">
                        <input type="checkbox" 
                               class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                               ${isPaid ? 'checked' : ''}
                               onclick="togglePaid('${row.id}')">
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pagination-info').innerText = `Mostrando ${start + 1}-${Math.min(end, groupedData.length)} de ${groupedData.length}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = end >= groupedData.length;
        }

        // --- COMPARADOR (VERSIÓN MEJORADA) ---
        function openComparator() {
            document.getElementById('comparator-modal').classList.remove('hidden');
            document.getElementById('comparator-search').focus();
        }

        function closeComparator() {
            document.getElementById('comparator-modal').classList.add('hidden');
        }

        function handleComparatorSearch(e) {
            // Normalizar texto para quitar acentos y pasar a minúsculas
            const normalize = (str) => String(str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            
            const term = normalize(e.target.value);
            const list = document.getElementById('comparator-list');
            const results = document.getElementById('comparator-results');
            const empty = document.getElementById('comparator-empty');

            if (term.length < 2) { 
                results.classList.add('hidden'); 
                empty.classList.remove('hidden'); 
                return; 
            }

            const dates = allData.map(d => new Date(d.Fecha));
            const maxDate = new Date(Math.max.apply(null, dates));
            const minDate = new Date(maxDate);
            minDate.setDate(minDate.getDate() - 30); 

            const matched = allData.filter(d => {
                const dDate = new Date(d.Fecha);
                // Comparación insensible a acentos
                return normalize(d.ArticuloNormalizado).includes(term) && dDate >= minDate;
            });
            
            if (matched.length === 0) {
                if(charts.comparator) charts.comparator.destroy();
                list.innerHTML = "";
                results.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            results.classList.remove('hidden');
            empty.classList.add('hidden');

            // Ordenar por fecha descendente (más reciente primero)
            matched.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));

            // Lógica para el gráfico (Mantenemos medias visuales para comparar)
            const grouped = matched.reduce((acc, curr) => {
                if(!acc[curr.Supermercado]) acc[curr.Supermercado] = [];
                acc[curr.Supermercado].push(curr.PrecioUnitario);
                return acc;
            }, {});

            const labels = Object.keys(grouped);
            const averages = labels.map(l => grouped[l].reduce((a,b) => a+b, 0) / grouped[l].length);

            if(charts.comparator) charts.comparator.destroy();
            charts.comparator = new Chart(document.getElementById('comparatorChart'), {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Precio Medio', 
                        data: averages, 
                        backgroundColor: '#2563eb', 
                        borderRadius: 15 
                    }] 
                },
                options: { 
                    indexAxis: 'y', // GRÁFICO HORIZONTAL
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Lógica de Lista (DETALLE: Supermercado, Día, Precio)
            list.innerHTML = matched.map(item => `
                <div class="bg-slate-50 p-4 rounded-2xl flex justify-between items-center border border-slate-100 hover:bg-white hover:shadow-md transition-all">
                    <div>
                        <h5 class="text-sm font-bold text-slate-800 mb-1">${item.ArticuloNormalizado}</h5> <!-- NUEVO CAMPO VISUAL -->
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${item.Supermercado}</p>
                        <div class="text-xs text-gray-500 mt-1"><i class="far fa-calendar-alt mr-1 text-blue-400"></i> ${item.Fecha}</div>
                    </div>
                    <div class="text-right">
                        <span class="block text-lg font-black text-blue-600">${item.PrecioUnitario.toFixed(2)} €</span>
                        <span class="text-[10px] text-slate-400">/ unidad</span>
                    </div>
                </div>
            `).join('');
        }

        // --- CHAT MULTI-FALLBACK ---
        function toggleChat() {
            const chat = document.getElementById('chat-window');
            if (chat.classList.contains('hidden')) {
                chat.classList.remove('hidden');
                document.getElementById('chat-input').focus();
            } else {
                chat.classList.add('hidden');
            }
        }

        function handleChatEnter(e) {
            if(e.key === 'Enter') sendChatMessage();
        }

        function addMessage(text, isUser = true) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `p-3 rounded-2xl max-w-[85%] shadow-sm text-sm ${isUser ? 'msg-user rounded-br-none' : 'msg-bot rounded-bl-none'}`;
            // USAR INNERHTML PARA RENDERIZAR <br> y <b>
            div.innerHTML = text; 
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(html) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'msg-system p-2 rounded my-2';
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            addMessage(text, true);
            input.value = '';
            
            const btn = document.getElementById('chat-send-btn');
            btn.disabled = true;
            
            const container = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'chat-typing';
            typingDiv.className = 'msg-bot p-3 rounded-2xl rounded-bl-none text-xs text-gray-500 italic';
            typingDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> Escribiendo...';
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;

            // Obtener el usuario actual para el contexto
            const currentUser = localStorage.getItem('crm_session_user') || 'usuario_anonimo';

            let success = false;

            // Intentar con lista de proxies
            for (const proxy of PROXIES) {
                try {
                    const target = proxy + encodeURIComponent(CHAT_WEBHOOK);
                    const url = proxy === "" ? CHAT_WEBHOOK : target; 
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json' 
                        },
                        // AÑADIDO: sessionId para mantener el contexto en n8n
                        body: JSON.stringify({ 
                            message: text,
                            sessionId: currentUser 
                        })
                    });

                    if (response.ok) {
                        const json = await response.json();
                        
                        // Normalizar datos (por si viene de proxy o directo)
                        let data = (json.contents && proxy.includes('allorigins')) ? JSON.parse(json.contents) : json;

                        // 1. Si es array (formato n8n habitual), tomamos el primer elemento
                        if (Array.isArray(data) && data.length > 0) {
                            data = data[0];
                        }

                        // 2. Extraer el texto
                        let rawText = data.output || data.message || (typeof data === 'object' ? JSON.stringify(data) : data);

                        // 3. Formatear (Markdown básico a HTML)
                        let formattedText = String(rawText)
                            .replace(/\n/g, '<br>')
                            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                            .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="underline text-blue-600">$1</a>');
                        
                        if(document.getElementById('chat-typing')) document.getElementById('chat-typing').remove();
                        addMessage(formattedText, false);
                        success = true;
                        break; 
                    }
                } catch (e) {
                    console.warn(`Chat falló con proxy ${proxy}:`, e);
                }
            }

            if (!success) {
                if(document.getElementById('chat-typing')) document.getElementById('chat-typing').remove();
                addSystemMessage('<i class="fas fa-exclamation-triangle"></i> Error CORS: El servidor bloqueó la respuesta.<br>Configura <b>"Allowed Origins: *"</b> en el Webhook de n8n.');
            }

            btn.disabled = false;
            input.focus();
        }

        // --- SIDEBAR DETALLES ---
        function openSidebar(title, filterKey, filterValue) {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            const content = document.getElementById('sidebar-content');
            
            document.getElementById('sidebar-title').innerText = filterValue;
            
            const dates = allData.map(d => new Date(d.Fecha));
            const maxDate = new Date(Math.max.apply(null, dates));
            const minDate = new Date(maxDate);
            minDate.setDate(minDate.getDate() - 30); 

            const detailsData = allData.filter(d => {
                const dDate = new Date(d.Fecha);
                return d[filterKey] === filterValue && dDate >= minDate;
            });
            
            detailsData.sort((a,b) => new Date(b.Fecha) - new Date(a.Fecha));

            document.getElementById('sidebar-subtitle').innerText = `Del ${minDate.toLocaleDateString()} al ${maxDate.toLocaleDateString()}`;
            document.getElementById('sidebar-count').innerText = `${detailsData.length} tickets`;

            content.innerHTML = '';
            if(detailsData.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-inbox fa-2x mb-2"></i><br>Sin movimientos recientes</div>';
            } else {
                detailsData.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-shadow";
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-gray-800 text-sm truncate w-3/4">${item.Articulo}</span>
                            <span class="font-bold text-blue-600 text-sm">${item.Total.toFixed(2)}€</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span><i class="far fa-calendar mr-1"></i>${item.Fecha}</span>
                            <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[100px]">${item.Supermercado}</span>
                        </div>
                    `;
                    content.appendChild(el);
                });
            }

            // CALCULAR TOTAL DEL SIDEBAR CON COLOR SEMÁNTICO
            const totalSum = detailsData.reduce((a,b) => a+b.Total, 0);
            const sumColor = totalSum < 0 ? 'text-emerald-600' : 'text-red-600';
            const sumEl = document.getElementById('sidebar-total-sum');
            sumEl.innerText = totalSum.toFixed(2) + " €";
            // Reset y aplicar color
            sumEl.className = `text-xl font-black ${sumColor}`;

            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            sidebar.classList.remove('translate-x-full');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            sidebar.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        // --- ACTUALIZACIÓN DE ESTADO CON NUEVA ESTRUCTURA ---
        async function togglePaid(ticketId) {
            const isPaid = !paidTickets.has(ticketId); 
            
            if (isPaid) {
                paidTickets.add(ticketId);
            } else {
                paidTickets.delete(ticketId);
            }
            localStorage.setItem('paid_tickets', JSON.stringify([...paidTickets]));
            renderTable();

            showToast("Sincronizando...", "blue");
            
            try {
                // AHORA TENEMOS 4 CAMPOS EN EL ID
                const [fecha, hora, superm, user] = ticketId.split('_');

                const response = await fetch(UPDATE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_status',
                        ticket_id: ticketId,
                        date: fecha,
                        time: hora, // Enviamos también la hora
                        supermarket: superm,
                        user: user,
                        status: isPaid ? 'COBRADO' : 'PENDIENTE'
                    })
                });

                if (response.ok) {
                    showToast("Guardado en servidor", "green");
                } else {
                    console.warn("El servidor no respondió OK, pero el cambio local persiste.");
                    showToast("Guardado localmente", "orange");
                }
            } catch (error) {
                console.warn("No se pudo conectar al webhook de actualización", error);
                showToast("Error de conexión (Guardado solo local)", "orange");
            }
        }

        function exportToCSV() {
            // USAR filteredTableData para exportar lo que se ve en tabla
            if (!filteredTableData.length) return alert("No hay datos para exportar");

            // Preparar datos con la marca de cobrado usando el nuevo formato de clave
            const exportData = filteredTableData.map(item => {
                const key = `${item.Fecha}_${item.Hora}_${item.Supermercado}_${item.Usuario}`;
                const isPaid = paidTickets.has(key) ? "COBRADO" : "PENDIENTE";
                return {
                    ...item,
                    Estado_Cobro: isPaid
                };
            });

            // Convertir a CSV
            const headers = Object.keys(exportData[0]);
            const csvRows = [
                headers.join(','), // Cabecera
                ...exportData.map(row => headers.map(fieldName => {
                    let val = row[fieldName];
                    // Escapar comillas y convertir a string
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(','))
            ];

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `tickets_export_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            // Usamos filteredTableData (Datos del Nuevo Webhook)
            const groupedData = groupTickets(filteredTableData);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = groupedData.slice(start, end);

            // Función para generar color consistente basado en texto
            const getCategoryStyle = (category) => {
                const normalizedCat = String(category).toUpperCase().trim();
                
                // Mapeo específico solicitado y comunes
                const specificMap = {
                    'ROPA Y COMPLEMENTOS': 'bg-green-100 text-green-800 border-green-200', // Solicitado: Verde
                    'CAFETERÍAS Y RESTAURANTES': 'bg-blue-100 text-blue-800 border-blue-200', // Solicitado: Azul
                    'ALIMENTACIÓN': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                    'SUPERMERCADO': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                    'GASOLINA': 'bg-red-100 text-red-800 border-red-200',
                    'COMBUSTIBLE': 'bg-red-100 text-red-800 border-red-200',
                    'FARMACIA': 'bg-teal-100 text-teal-800 border-teal-200',
                    'SALUD': 'bg-teal-100 text-teal-800 border-teal-200',
                    'HOGAR': 'bg-orange-100 text-orange-800 border-orange-200',
                    'MANTENIMIENTO': 'bg-gray-100 text-gray-800 border-gray-200',
                    'OCIO': 'bg-purple-100 text-purple-800 border-purple-200',
                    'VIAJES': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                    'EDUCACIÓN': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                    'REGALOS': 'bg-pink-100 text-pink-800 border-pink-200',
                    'BAZAR': 'bg-amber-100 text-amber-800 border-amber-200'
                };

                // Búsqueda exacta
                if (specificMap[normalizedCat]) return specificMap[normalizedCat];

                // Búsqueda parcial si no hay exacta
                for (const key in specificMap) {
                    if (normalizedCat.includes(key)) return specificMap[key];
                }

                // Si no está en la lista, generamos uno basado en el hash del string
                const colors = [
                    'bg-slate-100 text-slate-800 border-slate-200',
                    'bg-zinc-100 text-zinc-800 border-zinc-200',
                    'bg-stone-100 text-stone-800 border-stone-200',
                    'bg-red-100 text-red-800 border-red-200',
                    'bg-orange-100 text-orange-800 border-orange-200',
                    'bg-amber-100 text-amber-800 border-amber-200',
                    'bg-yellow-100 text-yellow-800 border-yellow-200',
                    'bg-lime-100 text-lime-800 border-lime-200',
                    'bg-green-100 text-green-800 border-green-200',
                    'bg-emerald-100 text-emerald-800 border-emerald-200',
                    'bg-teal-100 text-teal-800 border-teal-200',
                    'bg-cyan-100 text-cyan-800 border-cyan-200',
                    'bg-sky-100 text-sky-800 border-sky-200',
                    'bg-blue-100 text-blue-800 border-blue-200',
                    'bg-indigo-100 text-indigo-800 border-indigo-200',
                    'bg-violet-100 text-violet-800 border-violet-200',
                    'bg-purple-100 text-purple-800 border-purple-200',
                    'bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200',
                    'bg-pink-100 text-pink-800 border-pink-200',
                    'bg-rose-100 text-rose-800 border-rose-200'
                ];
                
                let hash = 0;
                for (let i = 0; i < normalizedCat.length; i++) {
                    hash = normalizedCat.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash) % colors.length;
                return colors[index];
            };

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No se encontraron datos</td></tr>';
                document.getElementById('pagination-info').innerText = '0 de 0';
                return;
            }

            pageData.forEach(row => {
                const isPaid = paidTickets.has(row.id);
                const tr = document.createElement('tr');
                tr.className = `bg-white border-b hover:bg-gray-50 transition table-row-hover ${isPaid ? 'row-paid opacity-75' : ''}`;
                
                // Determinar el estilo de la categoría dinámicamente
                let catClass = getCategoryStyle(row.Categoria);

                // Determinar color del TOTAL (Ingreso vs Gasto)
                const totalVal = parseFloat(row.Total);
                const moneyColor = totalVal < 0 ? 'text-emerald-600' : 'text-red-600';

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${row.Fecha}</td>
                    <td class="px-6 py-4">${row.Supermercado}</td>
                    <td class="px-6 py-4 hidden sm:table-cell">
                        <span class="${catClass} border text-[10px] font-bold mr-2 px-2.5 py-1 rounded-full uppercase tracking-wide shadow-sm whitespace-nowrap">
                            ${row.Categoria}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right font-bold ${moneyColor}">${totalVal.toFixed(2)} €</td>
                    <td class="px-6 py-4 text-center">
                        <input type="checkbox" 
                               class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                               ${isPaid ? 'checked' : ''}
                               onclick="togglePaid('${row.id}')">
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pagination-info').innerText = `Mostrando ${start + 1}-${Math.min(end, groupedData.length)} de ${groupedData.length}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = end >= groupedData.length;
        }

        // --- COMPARADOR (VERSIÓN MEJORADA) ---
        function openComparator() {
            document.getElementById('comparator-modal').classList.remove('hidden');
            document.getElementById('comparator-search').focus();
        }

        function closeComparator() {
            document.getElementById('comparator-modal').classList.add('hidden');
        }

        function handleComparatorSearch(e) {
            // Normalizar texto para quitar acentos y pasar a minúsculas
            const normalize = (str) => String(str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            
            const term = normalize(e.target.value);
            const list = document.getElementById('comparator-list');
            const results = document.getElementById('comparator-results');
            const empty = document.getElementById('comparator-empty');

            if (term.length < 2) { 
                results.classList.add('hidden'); 
                empty.classList.remove('hidden'); 
                return; 
            }

            const dates = allData.map(d => new Date(d.Fecha));
            const maxDate = new Date(Math.max.apply(null, dates));
            const minDate = new Date(maxDate);
            minDate.setDate(minDate.getDate() - 30); 

            const matched = allData.filter(d => {
                const dDate = new Date(d.Fecha);
                // Comparación insensible a acentos
                return normalize(d.ArticuloNormalizado).includes(term) && dDate >= minDate;
            });
            
            if (matched.length === 0) {
                if(charts.comparator) charts.comparator.destroy();
                list.innerHTML = "";
                results.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            results.classList.remove('hidden');
            empty.classList.add('hidden');

            // Ordenar por fecha descendente (más reciente primero)
            matched.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));

            // Lógica para el gráfico (Mantenemos medias visuales para comparar)
            const grouped = matched.reduce((acc, curr) => {
                if(!acc[curr.Supermercado]) acc[curr.Supermercado] = [];
                acc[curr.Supermercado].push(curr.PrecioUnitario);
                return acc;
            }, {});

            const labels = Object.keys(grouped);
            const averages = labels.map(l => grouped[l].reduce((a,b) => a+b, 0) / grouped[l].length);

            if(charts.comparator) charts.comparator.destroy();
            charts.comparator = new Chart(document.getElementById('comparatorChart'), {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Precio Medio', 
                        data: averages, 
                        backgroundColor: '#2563eb', 
                        borderRadius: 15 
                    }] 
                },
                options: { 
                    indexAxis: 'y', // GRÁFICO HORIZONTAL
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Lógica de Lista (DETALLE: Supermercado, Día, Precio)
            list.innerHTML = matched.map(item => `
                <div class="bg-slate-50 p-4 rounded-2xl flex justify-between items-center border border-slate-100 hover:bg-white hover:shadow-md transition-all">
                    <div>
                        <h5 class="text-sm font-bold text-slate-800 mb-1">${item.ArticuloNormalizado}</h5> <!-- NUEVO CAMPO VISUAL -->
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${item.Supermercado}</p>
                        <div class="text-xs text-gray-500 mt-1"><i class="far fa-calendar-alt mr-1 text-blue-400"></i> ${item.Fecha}</div>
                    </div>
                    <div class="text-right">
                        <span class="block text-lg font-black text-blue-600">${item.PrecioUnitario.toFixed(2)} €</span>
                        <span class="text-[10px] text-slate-400">/ unidad</span>
                    </div>
                </div>
            `).join('');
        }

        // --- CHAT MULTI-FALLBACK ---
        function toggleChat() {
            const chat = document.getElementById('chat-window');
            if (chat.classList.contains('hidden')) {
                chat.classList.remove('hidden');
                document.getElementById('chat-input').focus();
            } else {
                chat.classList.add('hidden');
            }
        }

        function handleChatEnter(e) {
            if(e.key === 'Enter') sendChatMessage();
        }

        function addMessage(text, isUser = true) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `p-3 rounded-2xl max-w-[85%] shadow-sm text-sm ${isUser ? 'msg-user rounded-br-none' : 'msg-bot rounded-bl-none'}`;
            // USAR INNERHTML PARA RENDERIZAR <br> y <b>
            div.innerHTML = text; 
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(html) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'msg-system p-2 rounded my-2';
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            addMessage(text, true);
            input.value = '';
            
            const btn = document.getElementById('chat-send-btn');
            btn.disabled = true;
            
            const container = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'chat-typing';
            typingDiv.className = 'msg-bot p-3 rounded-2xl rounded-bl-none text-xs text-gray-500 italic';
            typingDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> Escribiendo...';
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;

            // Obtener el usuario actual para el contexto
            const currentUser = localStorage.getItem('crm_session_user') || 'usuario_anonimo';

            let success = false;

            // Intentar con lista de proxies
            for (const proxy of PROXIES) {
                try {
                    const target = proxy + encodeURIComponent(CHAT_WEBHOOK);
                    const url = proxy === "" ? CHAT_WEBHOOK : target; 
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json' 
                        },
                        // AÑADIDO: sessionId para mantener el contexto en n8n
                        body: JSON.stringify({ 
                            message: text,
                            sessionId: currentUser 
                        })
                    });

                    if (response.ok) {
                        const json = await response.json();
                        
                        // Normalizar datos (por si viene de proxy o directo)
                        let data = (json.contents && proxy.includes('allorigins')) ? JSON.parse(json.contents) : json;

                        // 1. Si es array (formato n8n habitual), tomamos el primer elemento
                        if (Array.isArray(data) && data.length > 0) {
                            data = data[0];
                        }

                        // 2. Extraer el texto
                        let rawText = data.output || data.message || (typeof data === 'object' ? JSON.stringify(data) : data);

                        // 3. Formatear (Markdown básico a HTML)
                        let formattedText = String(rawText)
                            .replace(/\n/g, '<br>')
                            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                            .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="underline text-blue-600">$1</a>');
                        
                        if(document.getElementById('chat-typing')) document.getElementById('chat-typing').remove();
                        addMessage(formattedText, false);
                        success = true;
                        break; 
                    }
                } catch (e) {
                    console.warn(`Chat falló con proxy ${proxy}:`, e);
                }
            }

            if (!success) {
                if(document.getElementById('chat-typing')) document.getElementById('chat-typing').remove();
                addSystemMessage('<i class="fas fa-exclamation-triangle"></i> Error CORS: El servidor bloqueó la respuesta.<br>Configura <b>"Allowed Origins: *"</b> en el Webhook de n8n.');
            }

            btn.disabled = false;
            input.focus();
        }

        // --- SIDEBAR DETALLES ---
        function openSidebar(title, filterKey, filterValue) {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            const content = document.getElementById('sidebar-content');
            
            document.getElementById('sidebar-title').innerText = filterValue;
            
            const dates = allData.map(d => new Date(d.Fecha));
            const maxDate = new Date(Math.max.apply(null, dates));
            const minDate = new Date(maxDate);
            minDate.setDate(minDate.getDate() - 30); 

            const detailsData = allData.filter(d => {
                const dDate = new Date(d.Fecha);
                return d[filterKey] === filterValue && dDate >= minDate;
            });
            
            detailsData.sort((a,b) => new Date(b.Fecha) - new Date(a.Fecha));

            document.getElementById('sidebar-subtitle').innerText = `Del ${minDate.toLocaleDateString()} al ${maxDate.toLocaleDateString()}`;
            document.getElementById('sidebar-count').innerText = `${detailsData.length} tickets`;

            content.innerHTML = '';
            if(detailsData.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-inbox fa-2x mb-2"></i><br>Sin movimientos recientes</div>';
            } else {
                detailsData.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-shadow";
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-gray-800 text-sm truncate w-3/4">${item.Articulo}</span>
                            <span class="font-bold text-blue-600 text-sm">${item.Total.toFixed(2)}€</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span><i class="far fa-calendar mr-1"></i>${item.Fecha}</span>
                            <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[100px]">${item.Supermercado}</span>
                        </div>
                    `;
                    content.appendChild(el);
                });
            }

            // CALCULAR TOTAL DEL SIDEBAR CON COLOR SEMÁNTICO
            const totalSum = detailsData.reduce((a,b) => a+b.Total, 0);
            const sumColor = totalSum < 0 ? 'text-emerald-600' : 'text-red-600';
            const sumEl = document.getElementById('sidebar-total-sum');
            sumEl.innerText = totalSum.toFixed(2) + " €";
            // Reset y aplicar color
            sumEl.className = `text-xl font-black ${sumColor}`;

            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            sidebar.classList.remove('translate-x-full');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            sidebar.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        function renderCharts() {
            if (!filteredData || filteredData.length === 0) return;

            const groupBy = (arr, key) => arr.reduce((acc, curr) => {
                const value = curr[key] || 'Sin categoría';
                acc[value] = (acc[value] || 0) + curr.Total;
                return acc;
            }, {});

            const vendorData = groupBy(filteredData, 'Supermercado');
            const catData = groupBy(filteredData, 'Categoria');
            const timeData = groupBy(filteredData, 'Fecha');

            // Bar Chart
            if (charts.vendor) charts.vendor.destroy();
            charts.vendor = new Chart(document.getElementById('vendorChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(vendorData),
                    datasets: [{
                        label: 'Gasto (€)',
                        data: Object.values(vendorData),
                        backgroundColor: '#3b82f6',
                        borderRadius: 5,
                        hoverBackgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } },
                    onHover: (e, el) => e.native.target.style.cursor = el[0] ? 'pointer' : 'default',
                    onClick: (e, el) => {
                        if (el.length > 0) openSidebar('Supermercado', 'Supermercado', Object.keys(vendorData)[el[0].index]);
                    }
                }
            });

            // DEFINICIÓN DE COLORES POR CATEGORÍA
            const CATEGORY_COLORS = {
                'Alimentación': '#10b981', // Emerald
                'Supermercado': '#10b981', // Emerald (Alias)
                'Gasolina': '#ef4444',     // Red
                'Combustible': '#ef4444',  // Red (Alias)
                'Higiene': '#3b82f6',      // Blue
                'Limpieza': '#06b6d4',     // Cyan
                'Bazar': '#f59e0b',        // Amber
                'Mascotas': '#f97316',     // Orange
                'Ropa': '#ec4899',         // Pink
                'Ocio': '#8b5cf6',         // Violet
                'Farmacia': '#14b8a6',     // Teal
                'Electrónica': '#6366f1',  // Indigo
                'Hogar': '#84cc16',        // Lime
                'Otros': '#94a3b8'         // Slate
            };
            
            const DEFAULT_PALETTE = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', 
                '#ec4899', '#06b6d4', '#f97316', '#84cc16', '#6366f1'
            ];

            function getColorForCategory(category) {
                return CATEGORY_COLORS[category] || DEFAULT_PALETTE[Math.abs(category.length) % DEFAULT_PALETTE.length];
            }

            // Pie Chart
            if (charts.category) charts.category.destroy();
            
            const catLabels = Object.keys(catData);
            const catValues = Object.values(catData);
            const catColors = catLabels.map((cat, i) => CATEGORY_COLORS[cat] || DEFAULT_PALETTE[i % DEFAULT_PALETTE.length]); // Map colors dynamically

            charts.category = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catValues,
                        backgroundColor: catColors, // Use mapped colors
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 11} } } },
                    onHover: (e, el) => e.native.target.style.cursor = el[0] ? 'pointer' : 'default',
                    onClick: (e, el) => {
                        if (el.length > 0) openSidebar('Categoría', 'Categoria', Object.keys(catData)[el[0].index]);
                    }
                }
            });

            // Line Chart
            if (charts.timeline) charts.timeline.destroy();
            const timeLabels = Object.keys(timeData).sort();
            charts.timeline = new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Gasto Diario (€)',
                        data: timeLabels.map(k => timeData[k]),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } }, y: { beginAtZero: true } }
                }
            });
        }
    </script>
</body>
</html>