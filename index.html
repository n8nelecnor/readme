<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Gestión de Tickets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --bg-sidebar: #1e293b;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f3f4f6; }
        
        /* Efectos de carga */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 60; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
        
        /* Personalización de tabla */
        .table-row-hover:hover { background-color: #f8fafc; }
        th { cursor: pointer; user-select: none; }
        th:hover { color: var(--primary); }

        /* Scrollbar personalizada para el sidebar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Estilos para inputs de fecha en modo oscuro */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden relative">

    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
        <p class="text-gray-600 font-semibold" id="loader-text">Conectando con n8n...</p>
    </div>

    <!-- OVERLAY MENU MOVIL (IZQUIERDA) -->
    <div id="mobile-menu-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300 opacity-0 md:hidden"></div>

    <!-- OVERLAY DETALLES (DERECHA) -->
    <div id="details-overlay" onclick="closeSidebar()" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden transition-opacity duration-300 opacity-0"></div>
    
    <!-- SIDEBAR DE DETALLES (DERECHA) -->
    <div id="details-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
        <div class="p-4 bg-blue-600 text-white flex justify-between items-center shadow-md shrink-0">
            <div>
                <h3 class="font-bold text-lg" id="sidebar-title">Detalles</h3>
                <p class="text-xs text-blue-200" id="sidebar-subtitle">Últimos 30 días</p>
            </div>
            <button onclick="closeSidebar()" class="hover:bg-blue-700 p-2 rounded-full transition-colors w-8 h-8 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-3 bg-blue-50 border-b border-blue-100 shrink-0 flex justify-between items-center">
            <span class="text-xs font-semibold text-blue-800 uppercase tracking-wide">Tickets Recientes</span>
            <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full" id="sidebar-count">0 tickets</span>
        </div>
        <div class="flex-1 overflow-y-auto p-4 custom-scroll space-y-3" id="sidebar-content">
            <!-- Los items se inyectan aquí -->
        </div>
        <div class="p-4 border-t border-gray-100 bg-gray-50 shrink-0 text-center">
            <p class="text-xs text-gray-400">Mostrando datos filtrados por el último mes de actividad</p>
        </div>
    </div>

    <!-- SIDEBAR PRINCIPAL (IZQUIERDA) - AHORA RESPONSIVE -->
    <aside id="main-sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 text-white flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:relative md:z-0 shadow-xl md:shadow-none">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-blue-400"><i class="fas fa-receipt mr-2"></i>TicketCRM</h1>
                <p class="text-xs text-slate-400 mt-1">Gestión de Gastos</p>
            </div>
            <!-- Botón cerrar solo visible en móvil -->
            <button onclick="toggleMobileMenu()" class="md:hidden text-slate-400 hover:text-white p-2">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="#" class="flex items-center p-3 bg-blue-600 rounded-lg text-white shadow-lg" onclick="toggleMobileMenu()">
                <i class="fas fa-chart-line w-6 text-center"></i> <span class="ml-2">Dashboard</span>
            </a>
            <div class="mt-8">
                <p class="text-xs uppercase text-slate-500 font-bold mb-3 px-3">Filtros Rápidos</p>
                <div class="px-3 space-y-3">
                    <div>
                        <label class="text-xs text-slate-400">Supermercado</label>
                        <select id="filter-supermarket" class="w-full bg-slate-700 text-sm rounded p-2 mt-1 border border-slate-600 focus:border-blue-500 outline-none" onchange="applyFilters(); toggleMobileMenu()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Categoría</label>
                        <select id="filter-category" class="w-full bg-slate-700 text-sm rounded p-2 mt-1 border border-slate-600 focus:border-blue-500 outline-none" onchange="applyFilters(); toggleMobileMenu()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <!-- FILTRO DE USUARIO AÑADIDO AQUÍ -->
                    <div>
                        <label class="text-xs text-slate-400">Usuario</label>
                        <select id="filter-user" class="w-full bg-slate-700 text-sm rounded p-2 mt-1 border border-slate-600 focus:border-blue-500 outline-none" onchange="applyFilters(); toggleMobileMenu()">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <!-- FILTRO DE FECHAS -->
                    <div class="pt-2 border-t border-slate-700 mt-2">
                        <label class="text-xs text-slate-400 block mb-1">Rango de Fechas</label>
                        <div class="space-y-2">
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Desde</label>
                                <input type="date" id="filter-date-start" class="w-full bg-slate-700 text-sm rounded p-2 border border-slate-600 focus:border-blue-500 outline-none text-slate-200" onchange="applyFilters()">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Hasta</label>
                                <input type="date" id="filter-date-end" class="w-full bg-slate-700 text-sm rounded p-2 border border-slate-600 focus:border-blue-500 outline-none text-slate-200" onchange="applyFilters()">
                            </div>
                        </div>
                    </div>

                    <button onclick="resetFilters(); toggleMobileMenu()" class="w-full py-2 text-xs border border-slate-600 rounded hover:bg-slate-700 mt-2 transition-colors">
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-700 text-xs text-center text-slate-500">
            Conectado a Webhook n8n
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden w-full">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 shrink-0">
            <div class="flex items-center text-gray-800">
                <!-- Botón hamburguesa con cursor pointer explícito -->
                <button onclick="toggleMobileMenu()" class="md:hidden mr-4 text-gray-600 hover:text-blue-600 focus:outline-none cursor-pointer p-2 rounded-md hover:bg-gray-100 transition-colors">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h2 class="text-xl font-semibold truncate">Resumen General</h2>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                <div id="connection-status" class="hidden md:flex text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-700 items-center">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div> Online
                </div>
                <!-- Versión móvil del estado -->
                <div class="md:hidden w-3 h-3 bg-green-500 rounded-full animate-pulse" title="Online"></div>
                
                <button onclick="fetchData()" class="text-gray-500 hover:text-blue-600 p-2" title="Recargar datos">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
            
            <!-- KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
                <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-blue-600"><i class="fas fa-euro-sign fa-2x md:fa-3x"></i></div>
                    <p class="text-gray-500 text-xs md:text-sm font-medium">Gasto Total</p>
                    <h3 class="text-lg md:text-2xl font-bold text-gray-800 mt-1 truncate" id="kpi-total">0.00 €</h3>
                    <p class="text-[10px] md:text-xs text-green-500 mt-1 md:mt-2 font-semibold"><i class="fas fa-arrow-up"></i> Acumulado</p>
                </div>
                
                <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden hover:shadow-md transition">
                    <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-purple-600"><i class="fas fa-shopping-cart fa-2x md:fa-3x"></i></div>
                    <p class="text-gray-500 text-xs md:text-sm font-medium">Total Tickets</p>
                    <h3 class="text-lg md:text-2xl font-bold text-gray-800 mt-1" id="kpi-count">0</h3>
                </div>

                <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden hover:shadow-md transition">
                    <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-orange-600"><i class="fas fa-chart-pie fa-2x md:fa-3x"></i></div>
                    <p class="text-gray-500 text-xs md:text-sm font-medium">Ticket Medio</p>
                    <h3 class="text-lg md:text-2xl font-bold text-gray-800 mt-1 truncate" id="kpi-average">0.00 €</h3>
                </div>

                <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden hover:shadow-md transition">
                    <div class="absolute right-0 top-0 p-3 md:p-4 opacity-10 text-green-600"><i class="fas fa-calendar-alt fa-2x md:fa-3x"></i></div>
                    <p class="text-gray-500 text-xs md:text-sm font-medium">Última Compra</p>
                    <h3 class="text-sm md:text-lg font-bold text-gray-800 mt-1 truncate" id="kpi-last-date">-</h3>
                    <p class="text-[10px] md:text-xs text-gray-400 mt-1 truncate" id="kpi-last-vendor">-</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-gray-700 font-bold text-sm md:text-base">Gasto por Supermercado</h3>
                        <span class="text-[10px] md:text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded-full cursor-help flex items-center"><i class="fas fa-mouse-pointer mr-1"></i> <span class="hidden md:inline">Interactivo</span></span>
                    </div>
                    <div class="h-56 md:h-64">
                        <canvas id="vendorChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-gray-700 font-bold text-sm md:text-base">Distribución por Categoría</h3>
                        <span class="text-[10px] md:text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded-full cursor-help flex items-center"><i class="fas fa-mouse-pointer mr-1"></i> <span class="hidden md:inline">Interactivo</span></span>
                    </div>
                    <div class="h-56 md:h-64 flex justify-center">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            
             <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
                <h3 class="text-gray-700 font-bold mb-4 text-sm md:text-base">Evolución de Gasto Diario</h3>
                <div class="h-56 md:h-64 w-full">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 md:p-5 border-b border-gray-100 flex flex-col md:flex-row justify-between md:items-center gap-4">
                    <h3 class="text-lg font-bold text-gray-800">Detalle de Tickets</h3>
                    <div class="relative w-full md:w-auto">
                        <input type="text" id="search-input" placeholder="Buscar..." 
                               class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 w-full md:w-64"
                               onkeyup="handleSearch()">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3" onclick="sortTable('Fecha')">Fecha <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3" onclick="sortTable('Supermercado')">Super <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3 hidden md:table-cell" onclick="sortTable('Articulo')">Artículo <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3 hidden sm:table-cell" onclick="sortTable('Categoria')">Cat. <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3 hidden sm:table-cell" onclick="sortTable('Usuario')">Usuario <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-6 py-3 text-right" onclick="sortTable('Total')">Precio <i class="fas fa-sort text-gray-300 ml-1"></i></th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-100 flex justify-between items-center flex-wrap gap-2">
                    <span class="text-xs text-gray-500" id="pagination-info">Mostrando 0-0</span>
                    <div class="flex gap-2">
                        <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded text-gray-600 hover:bg-gray-200 text-xs disabled:opacity-50" id="btn-prev">Anterior</button>
                        <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded text-gray-600 hover:bg-gray-200 text-xs disabled:opacity-50" id="btn-next">Siguiente</button>
                    </div>
                </div>
            </div>

            <footer class="mt-8 text-center text-xs text-gray-400 pb-4">
                CRM Generado para Gestión de ODS &copy; 2025
            </footer>
        </div>
    </main>

    <script>
        // --- CONFIGURACIÓN ---
        const WEBHOOK_URL = 'https://automatizaciones-n8n.ztzbzz.easypanel.host/webhook/64dbf343-08e3-4a0b-8c8f-cd87c1554115';

        // Variables de estado
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        let sortCol = 'Fecha';
        let sortAsc = false;
        
        let charts = { vendor: null, category: null, timeline: null };

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        // --- FUNCIONES MÓVIL (CORREGIDO) ---
        function toggleMobileMenu() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('mobile-menu-overlay');
            
            // Comprobar si está oculto (tiene la clase de desplazamiento negativo)
            if (sidebar.classList.contains('-translate-x-full')) {
                // ABRIR
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0'); // Forzar posición visible
                
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                // CERRAR
                sidebar.classList.remove('translate-x-0'); // Quitar posición visible
                sidebar.classList.add('-translate-x-full'); // Volver a ocultar
                
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        async function fetchData() {
            const loader = document.getElementById('loader');
            // const statusBadge = document.getElementById('connection-status'); // Seleccionado dentro de lógica ahora
            loader.style.display = 'flex';

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                
                const json = await response.json();
                
                if (Array.isArray(json) && json.length > 0) {
                    allData = processData(json);
                    // Actualizar indicadores (móvil y escritorio)
                    // No hace falta código extra, el CSS oculta/muestra los divs adecuados
                } else {
                    throw new Error('Datos vacíos o formato incorrecto');
                }

            } catch (error) {
                console.warn("Fallo al conectar con n8n:", error);
                allData = generateDemoData();
                // En caso de demo, podrías cambiar el color de los indicadores con JS si quisieras
                document.getElementById('loader-text').innerText = "Cargando modo demostración...";
                await new Promise(r => setTimeout(r, 800));
            } finally {
                populateFilters();
                applyFilters();
                loader.style.display = 'none';
            }
        }

        function processData(data) {
            return data.map(item => ({
                Supermercado: item.Supermercado || "Desconocido",
                Direccion: item.Direccion || "",
                Poblacion: item.Poblacion || "General",
                Fecha: item.Fecha || new Date().toISOString().split('T')[0],
                Articulo: item.Articulo || "Producto Vario",
                CantidadPeso: parseFloat(item.CantidadPeso) || 1,
                Total: parseFloat(item.Total) || 0,
                Categoria: item.Categoria || "Otros",
                Usuario: item.Usuario || "Desconocido",
                PrecioUnitario: parseFloat(item["Precio Unitario"]) || 0,
                Descuento: parseFloat(item.Descuento) || 0
            }));
        }

        function generateDemoData() {
            const vendors = ['LIDL', 'Mercadona', 'Carrefour', 'Dia', 'Repsol'];
            const cats = ['Alimentación', 'Higiene', 'Limpieza', 'Gasolina', 'Bazar'];
            const products = ['Leche', 'Pan', 'Detergente', 'Gasolina 95', 'Galletas', 'Fruta', 'Verdura', 'Champú'];
            const users = ['Juan', 'Maria', 'Carlos'];
            let data = [];
            for(let i=0; i<50; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 60));
                data.push({
                    Supermercado: vendors[Math.floor(Math.random()*vendors.length)],
                    Direccion: 'Calle Demo ' + i,
                    Poblacion: i % 2 === 0 ? 'Sevilla' : 'Dos Hermanas',
                    Fecha: date.toISOString().split('T')[0],
                    Articulo: products[Math.floor(Math.random()*products.length)],
                    CantidadPeso: 1,
                    Total: parseFloat((Math.random() * 20 + 1).toFixed(2)),
                    Categoria: cats[Math.floor(Math.random()*cats.length)],
                    Usuario: users[Math.floor(Math.random()*users.length)]
                });
            }
            return data;
        }

        function populateFilters() {
            const vendors = [...new Set(allData.map(d => d.Supermercado))].sort();
            const cats = [...new Set(allData.map(d => d.Categoria))].sort();
            const users = [...new Set(allData.map(d => d.Usuario))].sort();

            const vendorSel = document.getElementById('filter-supermarket');
            const catSel = document.getElementById('filter-category');
            const userSel = document.getElementById('filter-user');
            
            const currentVendor = vendorSel.value;
            const currentCat = catSel.value;
            const currentUser = userSel.value;
            
            vendorSel.innerHTML = '<option value="">Todos</option>';
            catSel.innerHTML = '<option value="">Todas</option>';
            userSel.innerHTML = '<option value="">Todos</option>';

            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v; opt.innerText = v;
                vendorSel.appendChild(opt);
            });
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                catSel.appendChild(opt);
            });
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.innerText = u;
                userSel.appendChild(opt);
            });
            
            if(vendors.includes(currentVendor)) vendorSel.value = currentVendor;
            if(cats.includes(currentCat)) catSel.value = currentCat;
            if(users.includes(currentUser)) userSel.value = currentUser;
        }

        function applyFilters() {
            const vendorFilter = document.getElementById('filter-supermarket').value;
            const catFilter = document.getElementById('filter-category').value;
            const userFilter = document.getElementById('filter-user').value;
            const dateStart = document.getElementById('filter-date-start').value;
            const dateEnd = document.getElementById('filter-date-end').value;
            const search = document.getElementById('search-input').value.toLowerCase();

            filteredData = allData.filter(item => {
                const matchVendor = !vendorFilter || item.Supermercado === vendorFilter;
                const matchCat = !catFilter || item.Categoria === catFilter;
                const matchUser = !userFilter || item.Usuario === userFilter;
                const matchDateStart = !dateStart || item.Fecha >= dateStart;
                const matchDateEnd = !dateEnd || item.Fecha <= dateEnd;
                const matchSearch = !search || 
                                    item.Articulo.toLowerCase().includes(search) || 
                                    item.Supermercado.toLowerCase().includes(search);
                return matchVendor && matchCat && matchUser && matchDateStart && matchDateEnd && matchSearch;
            });

            filteredData.sort((a, b) => {
                let valA = a[sortCol];
                let valB = b[sortCol];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return sortAsc ? -1 : 1;
                if (valA > valB) return sortAsc ? 1 : -1;
                return 0;
            });

            currentPage = 1;
            updateDashboard();
            renderTable();
            renderCharts();
        }

        function resetFilters() {
            document.getElementById('filter-supermarket').value = "";
            document.getElementById('filter-category').value = "";
            document.getElementById('filter-user').value = "";
            document.getElementById('filter-date-start').value = "";
            document.getElementById('filter-date-end').value = "";
            document.getElementById('search-input').value = "";
            applyFilters();
        }

        function handleSearch() { applyFilters(); }
        function sortTable(col) {
            if (sortCol === col) sortAsc = !sortAsc;
            else { sortCol = col; sortAsc = true; }
            applyFilters();
        }
        function prevPage() { if(currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { if((currentPage * rowsPerPage) < filteredData.length) { currentPage++; renderTable(); } }

        function updateDashboard() {
            const total = filteredData.reduce((acc, curr) => acc + curr.Total, 0);
            const count = filteredData.length;
            const avg = count > 0 ? total / count : 0;
            
            document.getElementById('kpi-total').innerText = total.toLocaleString('es-ES', {style: 'currency', currency: 'EUR'});
            document.getElementById('kpi-count').innerText = count;
            document.getElementById('kpi-average').innerText = avg.toLocaleString('es-ES', {style: 'currency', currency: 'EUR'});

            if (count > 0) {
                const last = filteredData.reduce((prev, current) => (prev.Fecha > current.Fecha) ? prev : current);
                document.getElementById('kpi-last-date').innerText = new Date(last.Fecha).toLocaleDateString('es-ES');
                document.getElementById('kpi-last-vendor').innerText = last.Supermercado;
            } else {
                document.getElementById('kpi-last-date').innerText = "-";
                document.getElementById('kpi-last-vendor').innerText = "-";
            }
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No se encontraron datos</td></tr>';
                document.getElementById('pagination-info').innerText = '0 de 0';
                return;
            }

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 transition table-row-hover";
                
                let catColor = "bg-gray-100 text-gray-800";
                if(row.Categoria === 'Alimentación') catColor = "bg-green-100 text-green-800";
                else if(row.Categoria === 'Gasolina') catColor = "bg-red-100 text-red-800";
                else if(row.Categoria.includes('Limpieza')) catColor = "bg-blue-100 text-blue-800";

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${row.Fecha}</td>
                    <td class="px-6 py-4">${row.Supermercado}</td>
                    <td class="px-6 py-4 truncate max-w-xs hidden md:table-cell" title="${row.Articulo}">${row.Articulo}</td>
                    <td class="px-6 py-4 hidden sm:table-cell"><span class="${catColor} text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${row.Categoria}</span></td>
                    <td class="px-6 py-4 hidden sm:table-cell text-gray-500">${row.Usuario}</td>
                    <td class="px-6 py-4 text-right font-bold">${parseFloat(row.Total).toFixed(2)} €</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pagination-info').innerText = `Mostrando ${start + 1}-${Math.min(end, filteredData.length)} de ${filteredData.length}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = end >= filteredData.length;
        }

        // --- FUNCIONES SIDEBAR ---
        function openSidebar(title, filterKey, filterValue) {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            const content = document.getElementById('sidebar-content');
            
            document.getElementById('sidebar-title').innerText = filterValue;
            
            // Lógica "Último Mes"
            const dates = allData.map(d => new Date(d.Fecha));
            const maxDate = new Date(Math.max.apply(null, dates));
            const minDate = new Date(maxDate);
            minDate.setDate(minDate.getDate() - 30); 

            // Filtrar datos
            const detailsData = allData.filter(d => {
                const dDate = new Date(d.Fecha);
                return d[filterKey] === filterValue && dDate >= minDate;
            });
            
            detailsData.sort((a,b) => new Date(b.Fecha) - new Date(a.Fecha));

            document.getElementById('sidebar-subtitle').innerText = `Del ${minDate.toLocaleDateString()} al ${maxDate.toLocaleDateString()}`;
            document.getElementById('sidebar-count').innerText = `${detailsData.length} tickets`;

            content.innerHTML = '';
            
            if(detailsData.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-inbox fa-2x mb-2"></i><br>Sin movimientos recientes</div>';
            } else {
                detailsData.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-shadow";
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-gray-800 text-sm truncate w-3/4">${item.Articulo}</span>
                            <span class="font-bold text-blue-600 text-sm">${item.Total.toFixed(2)}€</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span><i class="far fa-calendar mr-1"></i>${item.Fecha}</span>
                            <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[100px]">${item.Supermercado}</span>
                        </div>
                    `;
                    content.appendChild(el);
                });
            }

            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            sidebar.classList.remove('translate-x-full');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('details-sidebar');
            const overlay = document.getElementById('details-overlay');
            
            sidebar.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        function renderCharts() {
            if (!filteredData || filteredData.length === 0) return;

            const groupBy = (arr, key) => {
                return arr.reduce((acc, curr) => {
                    const value = curr[key] || 'Sin categoría';
                    acc[value] = (acc[value] || 0) + curr.Total;
                    return acc;
                }, {});
            };

            const vendorDataRaw = groupBy(filteredData, 'Supermercado');
            const vendorLabels = Object.keys(vendorDataRaw);
            const vendorValues = Object.values(vendorDataRaw);

            const catDataRaw = groupBy(filteredData, 'Categoria');
            const catLabels = Object.keys(catDataRaw);
            const catValues = Object.values(catDataRaw);

            const timeDataRaw = groupBy(filteredData, 'Fecha');
            const timeLabels = Object.keys(timeDataRaw).sort();
            const timeValues = timeLabels.map(k => timeDataRaw[k]);

            // Chart: Supermercados
            if (charts.vendor) charts.vendor.destroy();
            const ctxVendor = document.getElementById('vendorChart').getContext('2d');
            charts.vendor = new Chart(ctxVendor, {
                type: 'bar',
                data: {
                    labels: vendorLabels,
                    datasets: [{
                        label: 'Gasto (€)',
                        data: vendorValues,
                        backgroundColor: '#3b82f6',
                        borderRadius: 5,
                        hoverBackgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            openSidebar('Supermercado', 'Supermercado', vendorLabels[idx]);
                        }
                    }
                }
            });

            // Chart: Categorías
            if (charts.category) charts.category.destroy();
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catValues,
                        backgroundColor: [
                            '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1',
                            '#14b8a6', '#f97316', '#06b6d4', '#84cc16', '#a855f7', '#f43f5e'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 10, font: {size: 11} } } 
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            openSidebar('Categoría', 'Categoria', catLabels[idx]);
                        }
                    }
                }
            });

            // Chart: Timeline
            if (charts.timeline) charts.timeline.destroy();
            const ctxTime = document.getElementById('timelineChart').getContext('2d');
            charts.timeline = new Chart(ctxTime, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Gasto Diario (€)',
                        data: timeValues,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
                        y: { beginAtZero: true } 
                    }
                }
            });
        }
    </script>
</body>
</html>